**OT\_REST**

**1.** Назначение  
**2.** Структура  
**3.** Описание пакетов и модулей  
**4.** Эндпоинты
<br>
<br>
---
<br>

**1. Назначение**

Приложение OT\_REST представляет собой веб-сервис, реализующий функционал для выполнения SPL запросов, получения результатов, сохранения их в кэш и выгрузки из кэша.

Текущая версия сервиса реализована с использованием python веб-фреймворка Tornado, позволяющего осуществлять асинхронную обработку запросов.
<br>
<br>
---
<br>


**2. Структура**

Структура приложения включает в себя:

- Исполняемый модуль **ot\_simple\_rest.py** , в котором происходит создание экземпляра приложения и запуск веб-сервера Tornado;
- Пакет **handlers** , содержащий модули с реализованными хэндлерами для обработки запросов;
- Пакет **jobs\_manager** , который отвечает за последовательное выполнение запросов типа makejob во избежание одновременных обращений к БД;
- Пакет **parsers**. Здесь собраны парсеры для обработки SPL;
- Пакет **utils** , содержащий вспомогательные инструменты;
- Пакет **tests** — юнит-тесты;
- Конфигурационный файл;
<br>
---
<br>


**3. Описание пакетов и модулей**

**1.** Модуль **ot\_simple\_rest.py**

Это основной модуль приложения, который является точкой входа для запуска.

В нём последовательно выполняются: настройка журналирования (logging),  считывание файла конфигурации, создание экземпляра job-менеджера и его запуск, создание экземпляра приложения Tornado Application, конфигурация эндпоинтов и запуск приложения на веб-сервере Tornado с привязкой к указанному сетевому порту.  
<br>
<br>


**2.** Пакет **jobs\_manager**

Пакет содержит модули jobs.py и manager.py реализующие, соответственно, классы заданий и менеджера для управления созданием и запуском заданий.

2.1 Модуль **jobs\_manager/jobs.py**

В данном модуле реализован класс **Job** , позволяющий создавать задания для OT\_Dispatcher, проверять статус заданий и получать результаты выполнения.

Класс **Job** принимает следующие аргументы при создании экземпляра:

<pre>
<b>request</b> — объект запроса, полученный в хэндлере;  
<b>db_conf</b> — настройки подключения к БД;  
<b>mem_conf</b> — настройки хранилища кэша;  
<b>resolver_conf</b> — настройки для класса Resolver из пакета parsers/spl_resolver;  
<b>tracker_max_interval</b> — размер интервала между проверками статуса OT_Dispatcher;  
<b>check_index_access</b> — флаг необходимости проверки доступа пользователя к индексам;  
</pre>

Список методов класса **Job** :

- _**check\_dispatcher\_status()**_ — проверка статуса диспетчера через обращение к БД;
- _**load\_and\_send\_from\_memcache(cid)**_ — данные из кэша по идентификатору _cid_;
- _**user\_has\_right(username, indexes)**_ — проверка прав доступа пользователя _username_ к списку индексов _indexes_ через обращение к БД;
- _**check\_cache( cache\_ttl, original\_spl, tws, twf, field\_extraction, preview )**_ — проверка наличия в БД записи о существовании кэша задания с указанными параметрами;
- _**check\_running( original\_spl, tws, twf, field\_extraction, preview )**_ — проверка наличия в БД записи о запущенном задании с указанными параметрами;
- _**get\_request\_params**_ — извлекает из объекта запроса (request) параметры SPL - запроса, необходимые для дальнейших манипуляций;
- _**start\_make**_ — проверяет существование кэша (check\_cache) и запущенного задания (check\_running). Если проверки дают отрицательный результат, создаёт новое задание в БД для OT\_Dispatcher с параметрами, полученными из get\_request\_params;
- _**start\_load**_ — проверяет статус задания с параметрами, полученными из get\_request\_params;

<br>


2.2 Модуль **jobs\_manager/manager.py**

Данный модуль содержит реализацию класса **JobsManager** , предназначенного для инкапсуляции методов для работы с объектами класса **Job**. В частности, для запуска заданий разных типов.

Текущая реализация использует асинхронную очередь для обработки заданий типа MakeJob, которые создаются и помещаются в очередь менеджером. Менеджер также отслеживает появление заданий в этой очереди и последовательно запускает их. Данный механизм позволяет избежать коллизий при выполнении проверок в БД.

Класс **JobManager** принимает следующие аргументы при создании экземпляра:

<pre>
<b>db_conf</b> — настройки подключения к БД;  
<b>mem_conf</b> — настройки хранилища кэша;  
<b>disp_conf</b> — настройки OT\_Dispatcher;  
<b>resolver_conf</b> — настройки для класса Resolver из пакета parsers/spl\_resolver;  
<b>user_conf</b> — параметры, касающиеся пользователей;  
</pre>

Список методов класса **JobManager** :

- **make\_job** — создание задания типа MakeJob;
- **load\_job** — создание и запуск задания типа LoadJob;
- **start** — запуск менеджера;
- **stop** — остановка менеджера;

<br>
<br>

**3.** Пакет **handlers**

В данном пакете содержатся все хэндлеры приложения OT\_REST.

Распределение хэндлеров по назначению осуществляется путём размещения их во вложенных пакетах с соответствующими названиями.

<br>

**3.1** Пакет **handlers/jobs**

Содержит модули, имеющие отношение к работе с джобами.

<br>

3.1.1 Модуль **handlers/jobs/makejob.py**

Обрабатывает POST - запросы на эндпоинт **/makejob.** В результате создаётся задание типа MakeJob и возвращается ответ.   

Варианты response:
<pre>
{"status": "success", "timestamp": "2020-02-10 12:00:00"}  
</pre>

<br>

3.1.2 Модуль **handlers/jobs/loadjob.py**

Обрабатывает GET - запросы на эндпоинт **/loadjob.** В результате создаётся и запускается задание типа LoadJob, результат которого возвращается в виде response. В ответе содержится статус задания, сообщение об ошибке (если произошла), результат выполнения джоба (если завершился).

Варианты response:

<pre>
{"status": "nocache"} — кэш не найден  
{"status": "new" / "running"} — новое/запущенное задание  
{"status": "failed / "canceled", "error": msg} — задание завершилось с ошибкой, либо отменено  
{"status": "notfound", "error": "Job is not found"} — задание не найдено в БД  
{"status": "success", "schema": "%s, events: {…}} - задание успешно завершено
</pre>

<br>

3.1.3 Модуль **handlers/jobs/db\_connector.py**

В данном модуле реализованы классы коннекторов к БД, предоставляющие API для выполнения всех необходимых операций с БД. Также внутри коннектора реализован механизм работы с ConnectionPool, избавляющий от необходимости создавать новое подключение при каждом новом обращении к эндпоинтам сервиса.

<br>

3.1.4 Модуль **handlers/jobs/saveotrest.py**

Обрабатывает POST - запросы на эндпоинт **/otrest.** Предоставляет механизм записи результатов работы приложения Splunk (ot\_simple) в RAM-кэш.

<br>

3.1.5 Модуль **handlers/jobs/checkjob.py**

3.1.6 Модуль **handlers/jobs/getdata.py**

Эти два модуля призваны заменить loadjob.py и представляют из себя раздельные хэндлеры для проверки статуса задания и получения результатов (данных из кэша).

<br>
<br>

**3.2** Пакет **handlers/service**

Содержит вспомогательные хэндлеры, не имеющие прямого отношения к работе с джобами.

3.2.1 Модуль **handlers/service/makedatamodels.py**

Обрабатывает POST - запросы на эндпоинт **/makedatamodels.** Реализует механизм создания моделей данных в БД.

<br>

3.2.2 Модуль **handlers/service/makerolemodels.py**

Обрабатывает POST - запросы на эндпоинт **/makerolemodels.** Реализует механизм создания ролевых моделей в БД.

<br>

3.3.3 Модуль **handlers/service/pingpong.py**

Обрабатывает GET/POST - запросы на эндпоинт **/ping** , позволяя проверить работоспособность сервера. Отвечает на запросы простым текстовым сообщением.

<br>
<br>

**4.** Пакет **parsers**

Содержит код, так или иначе связанный с парсингом текста SPL - запросов и его преобразованиями.

**4.1** Пакет **spl\_resolver**

4.1.1 Модуль **spl\_resolver/Resolver.py**

Содержит класс Resolver, предоставляющий методы для осуществления преобразований оригинального SPL - запроса к виду, необходимому для выполнения обработки в OT\_Dispatcher.

Класс **Resolver** принимает следующие аргументы при создании экземпляра:

<pre>
<b>indexes</b> — список индексов;  
<b>tws</b> — начало временного окна;  
<b>twf</b> — конец временного окна;  
<b>db</b> — объект коннектора к БД;  
<b>sid</b> — идентификатор запроса;  
<b>src_ip</b> — IP-адрес клиента;  
<b>no_subsearch_commands</b> — список команд, содержащих подзапросы, которые не нужно запускать;
</pre>

Список методов класса **Resolver** :

- _**create\_subsearch**_ — вычленяет подзапросы и выполняет преобразование вида:

<pre>
any_command [subsearch] -&gt; any_command subsearch=subsearch_id;
</pre>

- _**create\_otrest**_ — выполняет преобразование вида:

<pre>
| otrest endpoint=/any/path/to/api/ -&gt; | otrest subsearch=subsearch_id;
</pre>

- _**hide\_subsearch\_before\_read(query)**_ — выполняет замену subsearch в query на пустую строку и возвращает пару query, subsearch;
- _**create\_read\_graph**_ — Находит в запросе конструкции вида &quot;search \_\_fts\_query\_\_&quot; и выполняет преобразование вида:

<pre>
search __fts_query__ -&gt; read "{__fts_json__}";
</pre>

- _**create\_otstats\_graph**_ — Находит в запросе конструкции вида &quot;search \_\_fts\_query\_\_&quot; и выполняет преобразование вида:

<pre>
search __fts_query__ -&gt; otstats "{__fts_json__}";
</pre>

- _**create\_filter\_graph**_ — Находит в запросе конструкции вида &quot;search \_\_filter\_query\_\_&quot; и выполняет преобразование вида:

<pre>
search __filter_query__ -&gt; filter "{__filter_json__}";
</pre>

- _**create\_inputlookup\_filter**_ — Находит в запросе конструкции вида &quot;search \_\_otinputlookup\_query\_\_&quot; и выполняет преобразование вида:

<pre>
search __otinputlookup_query__ -&gt; otinputlookup "{__otinputlookup_json__}";
</pre>

- _**create\_datamodels**_ — выполняет преобразование вида:

<pre>
"| otfrom datamodel __NAME__" to "| search (index=__INDEX__ source=__SOURCE__)";
</pre>

- _**create\_otloadjob\_id**_ — выполняет преобразование вида:

<pre>
"| otloadjob __SID__" to "| otloadjob subsearch="subsearch___sha256__";
</pre>

- _**create\_otloadjob\_spl**_ — выполняет преобразование вида:

<pre>
| otloadjob spl="__SPL__" ___token___="__TOKEN__" ___tail___="__SPL__"
</pre>

to

<pre>
| otloadjob subsearch="subsearch___sha256__";
</pre>

<br>
<br>


**4.2** Пакет **spl\_to\_sparksql**

4.2.1 Модуль **spl\_to\_sparksql/internal/expressions/baseEvalExpression.py**

Содержит класс **BaseEvalExpression** с набором методов для преобразования синтаксиса SPL-выражений в SQL-выражения.

Список методов класса **BaseEvalExpression:**

- _**spl\_replace\_case**_ — преобразует все логические выражения в UpperCase;
- _**spl\_replace\_ws\_with\_and**_ — заменяет пробелы логическим AND;
- _**spl\_preprocess\_request**_ — вызывает _spl\_replace\_case &amp; spl\_replace\_ws\_with\_and;_
- _**remove\_index**_ — удаляет из SPL индексы и сохраняет информацию об индексах в переменной;
- _**transform\_equal**_ - преобразует выражения равенства;
- _**transform\_not\_equal**_ — преобразует выражения неравенства;
- _**transform\_end**_ — преобразует выражения AND;
- _**transform\_or**_ — преобразует выражения OR;
- _**transform\_not**_ — преобразует выражения NOT;
- _**transform\_comparison**_ — преобразует выражения сравнения;
- _**transform\_quotes**_ — преобразует выражения в кавычках;
- _**transform\_brackets**_ — преобразует выражения в скобках;
- _**transform\_comma**_ — преобразует выражения, разделённые запятой;
- _**return\_value**_ — преобразует значение с необязательным регулярным выражением в SPL формат;
- _**return\_string**_ — преобразует строку с необязательными подстроками _′\_raw like′_ или _′\_raw rlike′_

<br>

4.2.2 Модуль **spl\_to\_sparksql/internal/grammar.py**

В этом модуле описана LALR грамматика для синтаксического разбора SPL-запросов.

<br>

4.2.3 Модуль **spl\_to\_sparksql/internal/timerange.py**

Здесь содержится класс **Timerange** , имеющий два метода:

- _get\_timestamp(time) —_ извлекает из строки time информацию о дате-времени и преобразует её в значение unix timestamp;
- _removetime(spl, tws, twf) —_ удаляет из строки spl информацию о дате-времени и возвращает преобразованную строку и значения tws, twf, преобразованные в unix timestamp;

<br>

4.2.4 Модуль **spl\_to\_sparksql/splunk\_parser.py**

Содержит класс **SPLtoSQL** , выполняющий парсинг и преобразование SPL-запросов в SQL-запросы. Имеются два метода для парсинга запросов двух типов:

- _parse\_read(spl, av\_indexes, tws, twf)_ — функция для парсинга запросов типа read. Возвращает JSON-объект, в котором ключами являются индексы (в строковом представлении), а значениями словари вида {′query′:…, ′tws′:…, ′twf′:…};
- _parse\_filter(spl)_ — функция для парсинга запросов типа filter. Возвращает словарь с полями query (строка с SQL-запросом) и fields (список полей);
<br>
<br>
---
<br>

**4. Эндпоинты**

**/ping —  ** ′pong′ проверка работоспособности сервера;

**/makejob —** создание нового задания;

**/loadjob (\*deprecated) —** проверка статуса созданного задания и получение результатов выполнения;

**/checkjob —** проверка статуса созданного задания;

**/getresult —** получение результатов выполнения;

**/otrest —** сохранение результатов в RAM-cache;

**/makedatamodel —** добавление моделей данных в БД;

**/makerolemodel —** добавление ролевых моделей в БД;